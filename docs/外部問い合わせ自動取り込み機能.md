# カーセンサー・Goonet問い合わせ自動取り込み機能

## 概要
カーセンサーとGoonetからの問い合わせメールを自動でCRMに取り込み、問い合わせ一覧に表示する機能

## 機能フロー

### 1. メール受信トリガー
```
[カーセンサー] → [指定メールアドレス] → [CRM自動取り込み]
[Goonet]      → [指定メールアドレス] → [CRM自動取り込み]
```

### 2. メール解析・データ抽出
**カーセンサー問い合わせメールの構造**
```
件名: 【カーセンサー】お問い合わせがありました
送信者: customer@carsensor.net
本文:
  お客様情報:
  - お名前: 山田太郎
  - 電話番号: 090-1234-5678
  - メールアドレス: yamada@example.com
  
  車両情報:
  - 車種: トヨタ プリウス
  - 年式: 2021年
  - 価格: 228万円
  - 在庫番号: #CS12345
  
  問い合わせ内容:
  - 実車確認希望
  - 値引き可能か知りたい
```

**Goonet問い合わせメールの構造**
```
件名: [Goo-net]からお客様よりお問合せ
送信者: inquiry@goo-net.com
本文:
  ■お客様情報
  氏名：田中花子
  電話：080-9876-5432
  メール：tanaka@example.com
  
  ■車両情報
  メーカー：ホンダ
  車名：フィット
  年式：2020年
  価格：158万円
  管理番号：GN67890
  
  ■お問合せ内容
  試乗希望、ローンについて相談したい
```

### 3. 自動データ抽出機能
**正規表現・OCRによるデータ抽出**
```javascript
// カーセンサー用パターン
const carSensorPatterns = {
  name: /お名前[：:]\s*(.+)/,
  phone: /電話番号[：:]\s*([0-9-]+)/,
  email: /メールアドレス[：:]\s*([^\s]+)/,
  vehicle: /車種[：:]\s*(.+)/,
  year: /年式[：:]\s*([0-9]+)年/,
  price: /価格[：:]\s*([0-9,]+)万円/,
  stockNo: /在庫番号[：:]\s*(#?[A-Z0-9]+)/
};

// Goonet用パターン
const goonetPatterns = {
  name: /氏名[：:]\s*(.+)/,
  phone: /電話[：:]\s*([0-9-]+)/,
  email: /メール[：:]\s*([^\s]+)/,
  maker: /メーカー[：:]\s*(.+)/,
  model: /車名[：:]\s*(.+)/,
  year: /年式[：:]\s*([0-9]+)年/,
  price: /価格[：:]\s*([0-9,]+)万円/,
  managementNo: /管理番号[：:]\s*([A-Z0-9]+)/
};
```

### 4. CRMデータベースへの自動登録
```sql
-- 問い合わせテーブル
inquiries:
  inquiry_id (Primary Key)
  source ('carsensor' | 'goonet' | 'direct')
  received_at (受信日時)
  customer_name
  customer_phone
  customer_email
  vehicle_info (JSON)
  inquiry_content
  stock_number
  status ('new' | 'contacted' | 'visited' | 'closed')
  assigned_staff_id
  created_at
  updated_at

-- 重複チェック用
customer_inquiries:
  customer_id
  inquiry_id
  first_inquiry_date
  last_inquiry_date
  total_inquiries
```

## 画面設計

### 問い合わせ一覧画面
**目的**: 受信した問い合わせを一元管理・対応  
**機能**:
- 未対応・対応済みの色分け表示
- 緊急度による優先順位付け
- 担当者アサイン機能
- ワンクリック電話・メール返信

**レイアウト**:
```
[問い合わせ一覧]
┌─────────────────────────────────────────┐
│ 🔴NEW  カーセンサー  10:30                    │
│ 山田太郎 090-1234-5678                      │
│ プリウス 2021年 実車確認希望                │
│ [電話] [メール] [担当者設定]                │
├─────────────────────────────────────────┤
│ 🟡対応中 Goonet     09:15                   │
│ 田中花子 080-9876-5432  担当:鈴木           │
│ フィット 2020年 試乗・ローン相談            │
│ [電話] [メール] [詳細]                      │
└─────────────────────────────────────────┘
```

### 問い合わせ詳細画面
**目的**: 問い合わせ内容の詳細確認と対応  
**機能**:
- 元メールの完全表示
- 対応履歴の記録
- 該当車両の在庫確認
- 顧客情報との紐付け

### 自動返信設定画面
**目的**: 初動対応の自動化  
**機能**:
- 媒体別テンプレート設定
- 営業時間外対応
- 自動担当者アサイン

## 重複対応・名寄せ機能

### 既存顧客との照合
```javascript
// 顧客照合ロジック
function matchCustomer(inquiry) {
  // 1. 電話番号での完全一致
  let customer = findByPhone(inquiry.phone);
  
  // 2. メールアドレスでの完全一致  
  if (!customer) {
    customer = findByEmail(inquiry.email);
  }
  
  // 3. 名前の類似度判定（ひらがな・カタカナ変換含む）
  if (!customer) {
    customer = findBySimilarName(inquiry.name);
  }
  
  return customer;
}
```

### 重複問い合わせの統合
- 同一顧客からの複数問い合わせを統合
- 興味車種の変遷を記録
- 温度感の変化を可視化

## 実装技術

### メール受信処理
```typescript
// Supabase Edge Functionsでの実装
export default async function handler(req: Request) {
  const emailData = await req.json();
  
  // 送信者による振り分け
  const source = identifySource(emailData.sender);
  
  // データ抽出
  const extractedData = extractInquiryData(emailData.body, source);
  
  // CRMに登録
  const inquiry = await createInquiry(extractedData);
  
  // 担当者に通知
  await notifyAssignedStaff(inquiry);
  
  return new Response('OK');
}
```

### リアルタイム通知
```typescript
// スタッフのダッシュボードにリアルタイム通知
const subscription = supabase
  .channel('inquiries')
  .on('postgres_changes', {
    event: 'INSERT',
    schema: 'public',
    table: 'inquiries'
  }, (payload) => {
    showNotification(payload.new);
    updateInquiryList();
  })
  .subscribe();
```

## 期待効果

### 定量的効果
- 初動対応時間: 24時間 → 5分（自動返信）
- 対応漏れ: 5% → 0%
- 重複管理作業: 30分/日 → 0分

### 定性的効果
- お客様への迅速な対応による満足度向上
- スタッフの手作業削減
- 問い合わせデータの完全な記録・分析

## Phase 1 MVP実装範囲
1. 基本的なメール取り込み機能
2. 問い合わせ一覧表示
3. 簡単な自動返信
4. 担当者アサイン機能

## Phase 2 拡張機能
1. 高度なデータ抽出（OCR活用）
2. AI による顧客分析
3. 最適な対応タイミング提案
4. 成約率向上のためのA/Bテスト