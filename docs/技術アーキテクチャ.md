# BUDDICA CRM 技術アーキテクチャ

## システム構成図

```
┌─────────────────────────────────────────────────────────────┐
│                        クライアント                           │
│  Next.js (React) + Tailwind CSS + shadcn/ui                │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐         │
│  │   Pages     │ │ Components  │ │   Hooks     │         │
│  └─────────────┘ └─────────────┘ └─────────────┘         │
└─────────────────────────┬───────────────────────────────────┘
                          │ HTTPS
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                    Vercel Edge Network                      │
│                  (CDN + Serverless Functions)               │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                        Supabase                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐         │
│  │    Auth     │ │  Database   │ │  Realtime   │         │
│  │  (GoTrue)   │ │ (PostgreSQL)│ │ (WebSocket) │         │
│  └─────────────┘ └─────────────┘ └─────────────┘         │
│  ┌─────────────┐ ┌─────────────┐                          │
│  │   Storage   │ │  Edge Func  │                          │
│  │   (S3)      │ │   (Deno)    │                          │
│  └─────────────┘ └─────────────┘                          │
└─────────────────────────────────────────────────────────────┘
```

## 技術選定理由

### Frontend: Next.js 14 (App Router)
- **理由**: 
  - Server Componentsによる高速なレンダリング
  - ビルトインのルーティング機能
  - Vercelとの完璧な統合
  - TypeScriptの完全サポート

### UI Framework: Tailwind CSS + shadcn/ui
- **理由**:
  - 高速な開発とカスタマイズ性
  - アクセシビリティ対応済みコンポーネント
  - モダンで洗練されたデザイン
  - 軽量で高パフォーマンス

### Backend: Supabase
- **理由**:
  - PostgreSQLベースの堅牢性
  - リアルタイム機能の組み込み
  - 認証機能の標準提供
  - Row Level Security (RLS)
  - 無料枠が充実

### Hosting: Vercel
- **理由**:
  - Next.jsとの完璧な統合
  - 自動デプロイとプレビュー環境
  - エッジネットワークによる高速配信
  - 簡単な環境変数管理

## セキュリティ設計

### 1. 認証・認可
```typescript
// Supabase RLS ポリシー例
CREATE POLICY "Users can only see their own data"
ON customers
FOR SELECT
USING (auth.uid() = created_by);
```

### 2. データ暗号化
- HTTPS通信の強制
- Supabaseによる保存時暗号化
- 環境変数による秘密情報管理

### 3. CORS設定
```typescript
// next.config.js
module.exports = {
  async headers() {
    return [
      {
        source: '/api/:path*',
        headers: [
          { key: 'Access-Control-Allow-Origin', value: process.env.ALLOWED_ORIGIN },
        ],
      },
    ];
  },
};
```

## パフォーマンス最適化

### 1. キャッシュ戦略
- Vercel Edge Cacheの活用
- React Queryによるクライアントキャッシュ
- Supabaseの接続プーリング

### 2. バンドルサイズ最適化
- Dynamic importsの活用
- Tree shakingの最適化
- 画像の最適化（next/image）

### 3. データフェッチング戦略
```typescript
// Server Componentでのデータフェッチ
async function CustomerList() {
  const supabase = createServerComponentClient();
  const { data } = await supabase
    .from('customers')
    .select('*')
    .order('created_at', { ascending: false });
  
  return <CustomerTable data={data} />;
}
```

## 開発環境設定

### 必要なツール
- Node.js 18+
- pnpm (推奨)
- Git
- VS Code

### 環境変数
```env
# .env.local
NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-key
```

## CI/CD パイプライン

### GitHub Actions + Vercel
```yaml
# .github/workflows/deploy.yml
name: Deploy
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: pnpm/action-setup@v2
      - run: pnpm install
      - run: pnpm test
      - run: pnpm build
```

## モニタリング
- Vercel Analytics
- Supabase Dashboard
- エラートラッキング（Sentry検討）