# 新規顧客登録後のシステムフロー

## 登録完了時の即座の処理

### 1. データベース登録
```sql
-- 顧客マスタへの新規レコード挿入
INSERT INTO customers (
  customer_id,
  name,
  phone,
  email,
  visit_purpose,
  companion_type,
  preferred_vehicle,
  budget_range,
  usage_type,
  lead_source,
  assigned_staff_id,
  status,
  first_visit_date,
  created_at
) VALUES (
  uuid_generate_v4(),
  '山田太郎',
  '090-1234-5678',
  'yamada@example.com',
  '購入検討',
  'ご夫婦',
  'プリウス',
  '200万円',
  '通勤用',
  'walk-in',
  'staff_001',
  'new',
  NOW(),
  NOW()
);
```

### 2. 重複チェック・名寄せ処理
```javascript
async function checkDuplicateAndMerge(newCustomer) {
  // 電話番号での重複チェック
  const existingByPhone = await findByPhone(newCustomer.phone);
  
  if (existingByPhone) {
    return {
      action: 'duplicate_found',
      existingCustomerId: existingByPhone.customer_id,
      message: '既存顧客が見つかりました'
    };
  }
  
  // メールアドレスでの重複チェック
  const existingByEmail = await findByEmail(newCustomer.email);
  
  if (existingByEmail) {
    return {
      action: 'potential_duplicate',
      existingCustomerId: existingByEmail.customer_id,
      message: 'メールアドレスが一致する顧客がいます'
    };
  }
  
  // 名前の類似度チェック（機械学習）
  const similarCustomers = await findSimilarNames(newCustomer.name);
  
  return { action: 'new_customer', customerId: newCustomer.id };
}
```

### 3. 担当者アサインと通知
```javascript
async function assignStaffAndNotify(customerId, currentStaffId) {
  // 担当者履歴テーブルに記録
  await insertAssignmentHistory({
    customer_id: customerId,
    staff_id: currentStaffId,
    start_date: new Date(),
    assignment_type: 'initial'
  });
  
  // チームメンバーに通知（Slack/Teams連携）
  await sendTeamNotification({
    type: 'new_customer',
    message: `新規顧客「${customer.name}様」が登録されました`,
    assignedTo: currentStaffId,
    details: {
      visitPurpose: customer.visit_purpose,
      interestedVehicle: customer.preferred_vehicle,
      budget: customer.budget_range
    }
  });
}
```

## 登録方法別の分岐処理

### パターンA: 「今すぐ接客開始」を選択
```javascript
async function startImmediateService(customerId) {
  // 1. 商談レコード作成
  const dealId = await createDeal({
    customer_id: customerId,
    status: 'initial_contact',
    start_date: new Date(),
    staff_id: getCurrentStaffId()
  });
  
  // 2. 初回活動記録
  await createActivity({
    deal_id: dealId,
    activity_type: 'initial_meeting',
    description: '新規来店・初回接客開始',
    scheduled_date: new Date(),
    status: 'in_progress'
  });
  
  // 3. 画面遷移準備
  return {
    nextScreen: 'customer_detail',
    customerId: customerId,
    dealId: dealId,
    suggestedActions: [
      'needs_hearing',
      'inventory_search',
      'test_drive_proposal'
    ]
  };
}
```

### パターンB: 「詳細は後で入力」を選択
```javascript
async function saveForLaterProcessing(customerId) {
  // 1. タスク生成
  const taskId = await createTask({
    title: `${customer.name}様の詳細情報入力`,
    description: '新規顧客の詳細情報を入力してください',
    assigned_to: getCurrentStaffId(),
    customer_id: customerId,
    due_date: addHours(new Date(), 24), // 24時間以内
    priority: 'medium',
    task_type: 'customer_detail_input'
  });
  
  // 2. フォローアップスケジュール設定
  await scheduleFollowUp({
    customer_id: customerId,
    follow_up_type: 'initial_contact',
    scheduled_date: addHours(new Date(), 2), // 2時間後
    message_template: 'initial_visit_followup'
  });
  
  // 3. 画面遷移
  return {
    nextScreen: 'dashboard',
    message: '基本情報を保存しました',
    taskId: taskId
  };
}
```

## BigQueryへのデータ連携

### リアルタイムストリーミング
```javascript
async function streamToBigQuery(customerData) {
  const bigqueryRow = {
    insertId: `customer_${customerData.customer_id}_${Date.now()}`,
    json: {
      customer_id: customerData.customer_id,
      event_type: 'customer_registration',
      event_timestamp: new Date().toISOString(),
      staff_id: customerData.assigned_staff_id,
      store_id: getCurrentStoreId(),
      lead_source: customerData.lead_source,
      visit_purpose: customerData.visit_purpose,
      preferred_vehicle: customerData.preferred_vehicle,
      budget_range: customerData.budget_range,
      companion_type: customerData.companion_type
    }
  };
  
  await bigquery
    .dataset('crm_events')
    .table('customer_activities')
    .insert([bigqueryRow]);
}
```

## 自動化されるワークフロー

### 1. ウェルカムメッセージ送信
```javascript
// 30分後に自動送信
setTimeout(async () => {
  if (customer.email) {
    await sendWelcomeEmail({
      to: customer.email,
      customerName: customer.name,
      assignedStaff: staff.name,
      storeInfo: store
    });
  }
  
  if (customer.line_id) {
    await sendWelcomeLINE({
      to: customer.line_id,
      message: getWelcomeMessage(customer.name)
    });
  }
}, 30 * 60 * 1000);
```

### 2. AI分析・スコアリング
```javascript
async function analyzeNewCustomer(customerId) {
  const customer = await getCustomer(customerId);
  
  // 購買意欲スコア算出
  const intentScore = calculateIntentScore({
    visitPurpose: customer.visit_purpose,
    budgetClarity: customer.budget_range ? 100 : 50,
    vehicleSpecificity: customer.preferred_vehicle ? 80 : 30,
    companionType: customer.companion_type
  });
  
  // 類似顧客の成約パターン分析
  const similarCustomers = await findSimilarCustomerPatterns(customer);
  
  // 推奨アクション生成
  const recommendations = generateActionRecommendations({
    intentScore,
    similarPatterns: similarCustomers,
    currentContext: customer
  });
  
  // 結果をデータベースに保存
  await saveCustomerAnalysis(customerId, {
    intent_score: intentScore,
    recommendations: recommendations,
    analyzed_at: new Date()
  });
}
```

### 3. 在庫マッチング
```javascript
async function matchInventoryToCustomer(customerId) {
  const customer = await getCustomer(customerId);
  
  if (customer.preferred_vehicle && customer.budget_range) {
    // EXTREME APIから在庫検索
    const matchingVehicles = await searchInventory({
      model: customer.preferred_vehicle,
      maxPrice: parseBudget(customer.budget_range),
      storeId: getCurrentStoreId()
    });
    
    // マッチング結果を保存
    await saveVehicleMatches(customerId, matchingVehicles);
    
    // 担当者に通知
    if (matchingVehicles.length > 0) {
      await notifyStaff({
        type: 'inventory_match',
        customerId: customerId,
        matchCount: matchingVehicles.length,
        topMatch: matchingVehicles[0]
      });
    }
  }
}
```

## ダッシュボード更新

### リアルタイム通知
```javascript
// WebSocket経由でリアルタイム更新
function broadcastCustomerRegistration(customerData) {
  // 担当者の画面に即座に反映
  websocket.emit('new_customer', {
    customerId: customerData.customer_id,
    customerName: customerData.name,
    timestamp: new Date(),
    assignedStaff: customerData.assigned_staff_id
  });
  
  // チーム全体のダッシュボード更新
  websocket.emit('dashboard_update', {
    type: 'new_lead',
    count: await getTodaysNewCustomerCount()
  });
}
```

### 統計データ更新
```javascript
async function updateDashboardMetrics() {
  const today = new Date().toDateString();
  
  // 今日の新規顧客数
  const newCustomersToday = await countNewCustomers(today);
  
  // 来店目的別集計
  const visitPurposeStats = await getVisitPurposeStats(today);
  
  // 予算帯別集計
  const budgetStats = await getBudgetRangeStats(today);
  
  // キャッシュ更新
  await updateMetricsCache({
    new_customers_today: newCustomersToday,
    visit_purpose_breakdown: visitPurposeStats,
    budget_range_breakdown: budgetStats,
    updated_at: new Date()
  });
}
```

## エラーハンドリング

### 失敗時の処理
```javascript
async function handleRegistrationFailure(customerData, error) {
  // エラーログ記録
  await logError({
    event: 'customer_registration_failed',
    customerData: customerData,
    error: error.message,
    stack: error.stack,
    staffId: getCurrentStaffId(),
    timestamp: new Date()
  });
  
  // 一時保存（復旧用）
  await saveTemporaryData(`temp_customer_${Date.now()}`, customerData);
  
  // スタッフに通知
  await showNotification({
    type: 'error',
    message: '顧客登録に失敗しました。データは一時保存されています。',
    actions: ['retry', 'contact_support']
  });
}
```

## 成功時の次画面遷移

### 顧客詳細画面への遷移データ
```javascript
const transitionData = {
  customerId: newCustomerId,
  initialContext: 'new_registration',
  suggestedTabs: ['basic_info', 'needs_analysis', 'vehicle_matching'],
  quickActions: [
    { action: 'start_needs_hearing', label: 'ニーズヒアリング開始' },
    { action: 'search_inventory', label: '在庫検索' },
    { action: 'schedule_test_drive', label: '試乗予約' }
  ],
  customerInsights: {
    intentScore: analysisResult.intent_score,
    matchingVehicles: inventoryMatches,
    similarCustomerPatterns: similarPatterns
  }
};
```

このように、単純な「登録」ではなく、登録と同時に複数のシステムが連携して動き、次のアクションに向けた準備が自動的に行われます。